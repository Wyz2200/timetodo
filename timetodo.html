<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸Šæ¬¡æ˜¯ä»€éº¼æ™‚å€™ï¼Ÿ</title>
    <style>
        /* é è¨­é¡è‰²è®Šæ•¸ */
        :root {
            --primary: #4F46E5; /* é è¨­è—è‰² */
            --bg: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;
        }
        
        /* åˆå§‹åŒ– */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; }

        /* Header */
        header { background: var(--card-bg); padding: 15px; text-align: center; font-weight: bold; font-size: 1.2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .header-title { flex-grow: 1; text-align: center; }
        .header-btn { background: none; border: none; font-size: 1.4rem; color: var(--text-sub); cursor: pointer; padding: 0 10px; }
        .header-btn:active { opacity: 0.7; }

        /* Main Content Area */
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }

        /* Pages */
        .page { display: none; }
        .page.active { display: block; }

        /* Event Card (ä½¿ç”¨ --event-color è®Šæ•¸) */
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .event-title { font-size: 1.1rem; font-weight: 600; }
        .time-elapsed { font-size: 1.5rem; font-weight: 800; color: var(--event-color); margin: 10px 0; }
        .last-date { font-size: 0.85rem; color: var(--text-sub); }

        /* Buttons */
        .btn { border: none; padding: 10px 15px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; font-weight: 500; transition: opacity 0.2s; width: 100%; text-align: center; }
        .btn:active { opacity: 0.7; }
        .btn-primary { background-color: var(--event-color); color: white; margin-top: 10px; }
        .btn-outline { background-color: transparent; border: 1px solid #D1D5DB; color: var(--text-sub); margin-top: 8px; }
        .btn-danger { background-color: var(--danger); color: white; margin-top: 20px; }

        /* History Section */
        .history-list { margin-top: 15px; border-top: 1px solid #E5E7EB; padding-top: 10px; display: none; }
        .history-list.show { display: block; }
        /* èª¿æ•´æ­·å²ç´€éŒ„æ–‡å­—é¡è‰²ï¼Œæé«˜å°æ¯” (Request 2) */
        .history-item { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-main); padding: 5px 0; border-bottom: 1px dashed #eee; }
        .btn-del-history { color: var(--danger); background: none; border: none; cursor: pointer; font-size: 0.8rem; padding: 0 5px; }

        /* Modal (Add Event) */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 85%; max-width: 300px; }
        input[type="text"], input[type="color"] { width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 6px; margin: 10px 0; font-size: 1rem; }
        input[type="color"] { height: 40px; padding: 0; }

        /* Navbar */
        .navbar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #E5E7EB; display: flex; justify-content: space-around; align-items: center; padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); box-shadow: 0 -2px 10px rgba(0,0,0,0.03); z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); font-size: 0.75rem; border: none; background: none; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
        
        /* The Big Plus Button */
        .nav-add-btn { background: var(--primary); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; border: none; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4); transform: translateY(-15px); cursor: pointer; }
        .nav-add-btn:active { transform: translateY(-13px); }


        /* Calendar View Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; max-width: 400px; margin: 15px auto; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: 600; }
        .weekday-label { text-align: center; font-size: 0.8rem; color: var(--text-sub); padding: 5px 0; }
        .day-cell { text-align: center; padding: 8px 0; font-size: 0.9rem; background: var(--card-bg); border-radius: 4px; position: relative; }
        .day-cell.other-month { color: #ccc; }
        .day-cell.today { border: 2px solid var(--primary); }
        .day-cell.logged { background-color: #D1D5DB; font-weight: bold; color: var(--text-main); }
        .day-cell.logged::after { content: 'â€¢'; position: absolute; bottom: 1px; left: 0; right: 0; color: var(--primary); font-size: 1.5rem; line-height: 0; }
        .day-cell.logged-with-color::after { content: 'â€¢'; position: absolute; bottom: 1px; left: 0; right: 0; color: var(--logged-dot-color); font-size: 1.5rem; line-height: 0; }

        /* Edit/Color Block */
        .edit-block { margin-top: 15px; padding-top: 10px; border-top: 1px solid #E5E7EB; }
        .edit-block label { display: block; font-size: 0.9rem; margin-top: 10px; color: var(--text-sub); }
        .edit-color-picker { display: flex; gap: 10px; align-items: center; }
        .edit-color-picker input[type="color"] { width: 40px; height: 40px; padding: 3px; margin: 0; }
        .edit-color-picker input[type="text"] { flex-grow: 1; margin: 0; }
        .color-preview { width: 40px; height: 40px; border-radius: 6px; border: 1px solid #D1D5DB; }

        /* Global Settings Color Picker */
        .global-color-picker { display: flex; gap: 10px; align-items: center; }
        .global-color-picker input[type="color"] { width: 40px; height: 40px; padding: 3px; margin: 0; }
    </style>
</head>
<body>

    <header>
        <div style="width: 28px;"></div> <div id="header-title" class="header-title">æˆ‘çš„æ™‚é–“ç´€éŒ„</div>
        <button id="calendar-btn" class="header-btn" onclick="switchPage('calendar')">ğŸ—“ï¸</button>
    </header>

    <main>
        <div id="home-page" class="page active">
            <div id="event-list"></div>
            <div id="empty-state" style="text-align: center; color: #9CA3AF; margin-top: 50px; display: none;">
                é‚„æ²’æœ‰ç´€éŒ„äº‹é …<br>é»æ“Šä¸‹æ–¹ **+** æ–°å¢ä¸€å€‹å§ï¼
            </div>
        </div>

        <div id="calendar-page" class="page">
            <div class="calendar-header">
                <button class="header-btn" onclick="changeMonth(-1)">â—€ï¸</button>
                <span id="current-month-year">2025å¹´ 12æœˆ</span>
                <button class="header-btn" onclick="changeMonth(1)">â–¶ï¸</button>
            </div>
            <div class="calendar-grid">
                <div class="weekday-label">æ—¥</div>
                <div class="weekday-label">ä¸€</div>
                <div class="weekday-label">äºŒ</div>
                <div class="weekday-label">ä¸‰</div>
                <div class="weekday-label">å››</div>
                <div class="weekday-label">äº”</div>
                <div class="weekday-label">å…­</div>
            </div>
            <div id="calendar-days" class="calendar-grid">
                </div>
            
            <p style="text-align: center; color: var(--text-sub); font-size: 0.85rem; margin-top: 20px;">
                é»æ“Šæœ‰åœ“é»çš„æ—¥å­ï¼ŒæŸ¥çœ‹ç•¶æ—¥ç´€éŒ„ã€‚
            </p>

            <div id="daily-logs-display" style="margin-top: 20px;">
                </div>
        </div>

        <div id="settings-page" class="page">
            <div class="card">
                <div class="event-title">ğŸ¨ ç¨‹å¼è‰²èª¿è¨­å®š (é è¨­è—è‰²)</div>
                <p style="color: var(--text-sub); font-size: 0.9rem;">é€™æœƒæ›´æ”¹æ•´å€‹ App çš„ä¸»é¡Œè‰²ï¼ˆä¸»é ã€å°èˆªæ¬„ã€é è¨­äº‹ä»¶è‰²ï¼‰ã€‚</p>
                <label for="global-color">é¸æ“‡ä¸»é¡Œè‰²ï¼š</label>
                <div class="global-color-picker">
                    <input type="color" id="global-color" oninput="updateGlobalColor(this.value)">
                    <input type="text" id="global-color-hex" oninput="updateGlobalColor(this.value)">
                </div>
            </div>
            
            <div class="card">
                <div class="event-title">è³‡æ–™ç®¡ç†</div>
                <p style="color: var(--text-sub); font-size: 0.9rem;">æ‰€æœ‰è³‡æ–™éƒ½å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ã€‚</p>
                <button class="btn btn-danger" onclick="clearAllData()">âš ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
            <div class="card">
                <div class="event-title">é—œæ–¼</div>
                <p style="color: var(--text-sub); font-size: 0.9rem;">é€™æ˜¯ä¸€å€‹ç°¡æ˜“çš„æ™‚é–“è¿½è¹¤å·¥å…·ã€‚</p>
            </div>
        </div>
    </main>

    <div id="add-modal" class="modal" onclick="if(event.target.id === 'add-modal') closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="event-title">æ–°å¢è¿½è¹¤äº‹é …</div>
            <input type="text" id="new-event-name" placeholder="ä¾‹å¦‚ï¼šæ›åºŠå–®ã€æ¾†æ°´...">
            <label for="new-event-color" style="font-size: 0.9rem;">äº‹ä»¶é¡è‰²ï¼š</label>
            <div class="edit-color-picker">
                <input type="color" id="new-event-color" value="#4F46E5">
                <input type="text" id="new-event-color-hex" value="#4F46E5" oninput="document.getElementById('new-event-color').value=this.value">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" style="--event-color: var(--primary);" onclick="saveNewEvent()">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

    <nav class="navbar">
        <button class="nav-item active" onclick="switchPage('home')">
            <span class="nav-icon">ğŸ </span>
            <span>ä¸»é </span>
        </button>
        <button class="nav-add-btn" style="background: var(--primary);" onclick="openModal()">
            +
        </button>
        <button class="nav-item" onclick="switchPage('settings')">
            <span class="nav-icon">âš™ï¸</span>
            <span>è¨­å®š</span>
        </button>
    </nav>

    <script>
        // --- å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        const LOCAL_STORAGE_KEY = 'myTimeTracker_events_v2';
        const GLOBAL_COLOR_KEY = 'myTimeTracker_global_color';
        let events = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || [];
        let currentDate = new Date(); // for Calendar View

        // åˆå§‹åŒ–å…¨åŸŸé¡è‰²
        const storedColor = localStorage.getItem(GLOBAL_COLOR_KEY) || '#4F46E5';
        document.documentElement.style.setProperty('--primary', storedColor);

        // ç¢ºä¿æ¯å€‹äº‹ä»¶éƒ½æœ‰é¡è‰²å±¬æ€§ (Request 1)
        events = events.map(e => ({
            ...e,
            color: e.color || storedColor,
            logs: e.logs || []
        }));


        function saveToLocal() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(events));
            renderEvents();
        }

        // --- é¡è‰²è¨­å®šé‚è¼¯ (Request 1) ---

        function updateGlobalColor(color) {
            // ç°¡åŒ–é¡è‰²è¼¸å…¥ï¼Œå¦‚æœä½¿ç”¨è€…å¾æ–‡å­—è¼¸å…¥æ¡†è¼¸å…¥
            if (color.length === 6 && !color.startsWith('#')) {
                color = '#' + color;
            }
            if (color.match(/^#([0-9A-F]{3}){1,2}$/i)) {
                document.documentElement.style.setProperty('--primary', color);
                document.querySelector('.nav-add-btn').style.background = color;
                document.getElementById('global-color').value = color;
                document.getElementById('global-color-hex').value = color;
                localStorage.setItem(GLOBAL_COLOR_KEY, color);

                // æ›´æ–°æ–°å¢äº‹ä»¶ modal é è¨­é¡è‰²
                document.getElementById('new-event-color').value = color;
                document.getElementById('new-event-color-hex').value = color;
                document.querySelector('#add-modal .btn-primary').style.setProperty('--event-color', color);
            }
        }
        
        function updateEventColor(id, newColor) {
            const event = events.find(e => e.id === id);
            if (event && newColor.match(/^#([0-9A-F]{3}){1,2}$/i)) {
                event.color = newColor;
                saveToLocal();
            }
        }

        function updateEventName(id, newName) {
            const event = events.find(e => e.id === id);
            if (event && newName.trim()) {
                event.name = newName.trim();
                saveToLocal();
            }
        }


        // --- æ™‚é–“æ ¼å¼åŒ–é‚è¼¯ (Request 5) ---
        const WEEKDAYS = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];

        function formatDuration(ms) {
            if (ms === null) return "å°šæœªåŸ·è¡Œ";
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days}å¤© ${hours % 24}å°æ™‚`;
            if (hours > 0) return `${hours}å°æ™‚ ${minutes % 60}åˆ†`;
            if (minutes > 0) return `${minutes}åˆ†é˜å‰`;
            return "å‰›å‰›";
        }

        function formatLogDate(timestamp) {
            const date = new Date(timestamp);
            const dayOfWeek = WEEKDAYS[date.getDay()]; // Request 5
            return `${date.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false })} (${dayOfWeek})`;
        }


        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        // 1. Modal æ“æ§
        function openModal() {
            // ç¢ºä¿ modal é è¨­é¡è‰²æ˜¯æœ€æ–°çš„ global color
            const globalColor = localStorage.getItem(GLOBAL_COLOR_KEY) || '#4F46E5';
            document.getElementById('new-event-color').value = globalColor;
            document.getElementById('new-event-color-hex').value = globalColor;
            document.querySelector('#add-modal .btn-primary').style.setProperty('--event-color', globalColor);

            document.getElementById('add-modal').classList.add('show');
            document.getElementById('new-event-name').focus();
        }

        function closeModal() {
            document.getElementById('add-modal').classList.remove('show');
            document.getElementById('new-event-name').value = '';
        }

        function saveNewEvent() {
            const name = document.getElementById('new-event-name').value.trim();
            const color = document.getElementById('new-event-color').value;

            if (!name) return alert('è«‹è¼¸å…¥åç¨±');
            
            const newEvent = {
                id: Date.now(),
                name: name,
                color: color, // Request 1
                logs: [] 
            };
            
            events.push(newEvent);
            saveToLocal();
            closeModal();
            switchPage('home');
        }

        // 2. ç´€éŒ„æ™‚é–“ (æ‰“å¡) (Request 4: é˜²é‡è¤‡ç´€éŒ„)
        function logTime(id) {
            const event = events.find(e => e.id === id);
            if (!event) return;

            const now = Date.now();
            const lastLog = event.logs.length > 0 ? event.logs[0] : 0;
            const diff = now - lastLog;
            
            // æª¢æŸ¥æ˜¯å¦åœ¨ 5 ç§’å…§é‡è¤‡é»æ“Š (Request 4)
            if (diff > 0 && diff < 5000) { 
                alert(`å¤ªå¿«äº†ï¼é€™å€‹äº‹ä»¶å‰›å‰›å·²åœ¨ ${formatLogDate(lastLog)} ç´€éŒ„ã€‚`);
                return;
            }

            event.logs.unshift(now); // åŠ åˆ°æœ€å‰é¢
            saveToLocal();
        }

        // 3. åˆªé™¤ç‰¹å®šæ­·å²ç´€éŒ„
        function deleteLog(eventId, logIndex) {
            if(confirm('ç¢ºå®šåˆªé™¤é€™æ¢ç´€éŒ„å—ï¼Ÿ')) {
                const event = events.find(e => e.id === eventId);
                event.logs.splice(logIndex, 1);
                saveToLocal();
            }
        }

        // 4. åˆªé™¤æ•´å€‹äº‹ä»¶
        function deleteEvent(id) {
            if(confirm('ç¢ºå®šåˆªé™¤é€™å€‹äº‹ä»¶èˆ‡æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ')) {
                events = events.filter(e => e.id !== id);
                saveToLocal();
            }
        }

        // 5. åˆ‡æ›æ­·å²é¡¯ç¤º
        function toggleHistory(id) {
            const el = document.getElementById(`history-${id}`);
            el.classList.toggle('show');
        }

        // --- æ¸²æŸ“ç•«é¢ (UI) ---
        function renderEvents() {
            const list = document.getElementById('event-list');
            const emptyState = document.getElementById('empty-state');
            
            list.innerHTML = '';
            
            if (events.length === 0) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
            }

            events.forEach(evt => {
                const lastLog = evt.logs.length > 0 ? evt.logs[0] : null;
                const timeDiff = lastLog ? Date.now() - lastLog : null;
                const displayTime = formatDuration(timeDiff);
                
                // æ­·å²ç´€éŒ„ HTML
                let historyHtml = '';
                evt.logs.forEach((log, index) => {
                    historyHtml += `
                        <div class="history-item">
                            <span>${formatLogDate(log)}</span>
                            <button class="btn-del-history" onclick="deleteLog(${evt.id}, ${index})">åˆªé™¤</button>
                        </div>
                    `;
                });

                const card = document.createElement('div');
                card.className = 'card';
                // ä½¿ç”¨äº‹ä»¶ç¨ç«‹é¡è‰² (Request 1)
                card.style.setProperty('--event-color', evt.color); 
                card.innerHTML = `
                    <div class="card-header">
                        <input type="text" id="name-${evt.id}" value="${evt.name}" class="event-title" 
                            onchange="updateEventName(${evt.id}, this.value)" 
                            style="border: none; padding: 0; margin: 0; font-size: 1.1rem; font-weight: 600; background: none; flex-grow: 1;">
                        <button style="border:none;background:none;color:#999;" onclick="deleteEvent(${evt.id})">âœ•</button>
                    </div>
                    <div class="last-date">${lastLog ? 'ä¸Šæ¬¡ï¼š' + formatLogDate(lastLog).split(' (')[0] : 'æ–°äº‹ä»¶'}</div>
                    <div class="time-elapsed">${displayTime}</div>
                    
                    <button class="btn btn-primary" onclick="logTime(${evt.id})">âœ”ï¸ å‰›å‰›åšäº†</button>
                    <button class="btn btn-outline" onclick="toggleHistory(${evt.id})">ğŸ“‹ æ­·å²ç´€éŒ„ & è¨­å®š</button>
                    
                    <div id="history-${evt.id}" class="history-list">
                        <div class="edit-block">
                            <label>æ›´æ”¹äº‹ä»¶åç¨±ï¼š</label>
                            <input type="text" value="${evt.name}" onchange="updateEventName(${evt.id}, this.value)">

                            <label for="color-${evt.id}">æ›´æ”¹äº‹ä»¶é¡è‰²ï¼š</label>
                            <div class="edit-color-picker">
                                <input type="color" id="color-${evt.id}" value="${evt.color}" 
                                    oninput="updateEventColor(${evt.id}, this.value)">
                                <input type="text" value="${evt.color}" onchange="updateEventColor(${evt.id}, this.value)" style="flex-grow: 1;">
                            </div>
                        </div>

                        <div class="edit-block">
                            <p style="font-weight: 600; color: var(--text-main);">æ‰€æœ‰åŸ·è¡Œç´€éŒ„:</p>
                            ${historyHtml || '<div style="text-align:center;padding:10px;color:var(--text-sub);">å°šç„¡ç´€éŒ„</div>'}
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // --- é é¢åˆ‡æ› ---
        function switchPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // éš±è—æ—¥æ›†æŒ‰éˆ• (åªåœ¨ä¸»é é¡¯ç¤º)
            document.getElementById('calendar-btn').style.display = pageName === 'home' ? 'block' : 'none';

            if (pageName === 'home') {
                document.getElementById('home-page').classList.add('active');
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
                document.getElementById('header-title').innerText = "æˆ‘çš„æ™‚é–“ç´€éŒ„";
            } else if (pageName === 'settings') {
                // è¼‰å…¥è¨­å®šé æ™‚ï¼Œæ›´æ–°é¡è‰²é¸å–å™¨ç‹€æ…‹
                const currentColor = localStorage.getItem(GLOBAL_COLOR_KEY) || '#4F46E5';
                updateGlobalColor(currentColor);
                
                document.getElementById('settings-page').classList.add('active');
                document.querySelector('.nav-item:nth-child(3)').classList.add('active');
                document.getElementById('header-title').innerText = "è¨­å®š";
            } else if (pageName === 'calendar') { // Request 3
                document.getElementById('calendar-page').classList.add('active');
                document.getElementById('header-title').innerText = "è¡Œäº‹æ›†æª¢è¦–";
                renderCalendar();
            }
        }

        // --- è¨­å®šé åŠŸèƒ½ ---
        function clearAllData() {
            if(confirm("é€™å°‡æœƒåˆªé™¤æ‰€æœ‰è³‡æ–™ä¸”ç„¡æ³•å¾©åŸï¼ç¢ºå®šå—ï¼Ÿ")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                events = [];
                renderEvents();
                switchPage('home');
                alert("è³‡æ–™å·²æ¸…é™¤");
            }
        }

        // --- è¡Œäº‹æ›†åŠŸèƒ½ (Request 3) ---

        function getMonthData(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const numDays = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay(); // 0 (Sun) to 6 (Sat)
            const today = new Date();

            // æå–ç•¶æœˆæ‰€æœ‰æœ‰ç´€éŒ„çš„æ—¥æœŸå’Œé¡è‰²
            const loggedDates = {}; 
            events.forEach(event => {
                event.logs.forEach(timestamp => {
                    const logDate = new Date(timestamp);
                    if (logDate.getFullYear() === year && logDate.getMonth() === month) {
                        const day = logDate.getDate();
                        if (!loggedDates[day]) {
                            loggedDates[day] = [];
                        }
                        loggedDates[day].push({ name: event.name, color: event.color, time: timestamp });
                    }
                });
            });

            return { numDays, startDayOfWeek, today, loggedDates };
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const todayDate = new Date().toDateString();

            const { numDays, startDayOfWeek, loggedDates } = getMonthData(year, month);
            const calendarDaysEl = document.getElementById('calendar-days');
            const monthYearEl = document.getElementById('current-month-year');
            
            monthYearEl.textContent = `${year}å¹´ ${month + 1}æœˆ`;
            calendarDaysEl.innerHTML = '';
            document.getElementById('daily-logs-display').innerHTML = ''; // æ¸…ç©ºæ¯æ—¥ç´€éŒ„é¡¯ç¤º

            // å¡«å……å‰ä¸€å€‹æœˆçš„ç©ºç™½
            for (let i = 0; i < startDayOfWeek; i++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell other-month';
                cell.textContent = ''; // å¯ä»¥é¡¯ç¤ºä¸Šå€‹æœˆçš„æ—¥æœŸï¼Œä½†ç‚ºæ±‚ç°¡æ½”å…ˆç•™ç©º
                calendarDaysEl.appendChild(cell);
            }

            // å¡«å……ç•¶æœˆçš„æ—¥æœŸ
            for (let day = 1; day <= numDays; day++) {
                const dayDate = new Date(year, month, day);
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                cell.textContent = day;

                // æ¨™è¨˜ä»Šå¤©
                if (dayDate.toDateString() === todayDate) {
                    cell.classList.add('today');
                }

                if (loggedDates[day]) {
                    cell.classList.add('logged');
                    cell.style.setProperty('--logged-dot-color', loggedDates[day][0].color); // ä½¿ç”¨ç¬¬ä¸€å€‹äº‹ä»¶çš„é¡è‰²ä½œç‚ºåœ“é»é¡è‰²
                    cell.onclick = () => showDailyLogs(year, month, day, loggedDates[day]);
                }
                
                calendarDaysEl.appendChild(cell);
            }
        }

        function changeMonth(step) {
            currentDate.setMonth(currentDate.getMonth() + step);
            renderCalendar();
        }

        function showDailyLogs(year, month, day, logs) {
            const displayEl = document.getElementById('daily-logs-display');
            logs.sort((a, b) => b.time - a.time); // å€’åºæ’åˆ—

            let html = `
                <div class="card" style="margin-top: 0;">
                    <h3 style="margin-top: 0; border-bottom: 2px solid var(--primary); padding-bottom: 5px;">${year}å¹´${month + 1}æœˆ${day}æ—¥ ç´€éŒ„ç¸½è¦½</h3>
            `;
            
            // æ•´ç† logs å…§å®¹ï¼Œåƒ…ä¿ç•™ç¨ç‰¹çš„äº‹ä»¶åç¨±
            const uniqueLogs = {};
            logs.forEach(log => {
                if (!uniqueLogs[log.name]) {
                    uniqueLogs[log.name] = { logs: [], color: log.color };
                }
                uniqueLogs[log.name].logs.push(log.time);
            });

            for (const name in uniqueLogs) {
                const data = uniqueLogs[name];
                html += `
                    <div style="border-left: 5px solid ${data.color}; padding-left: 10px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 5px 0; color: ${data.color};">${name}</h4>
                        ${data.logs.map(time => `<div style="font-size: 0.9rem; color: var(--text-main);">${formatLogDate(time).split(' (')[0]}</div>`).join('')}
                    </div>
                `;
            }

            html += `</div>`;
            displayEl.innerHTML = html;
        }


        // --- å•Ÿå‹•èˆ‡è‡ªå‹•æ›´æ–° ---
        
        // æ¯åˆ†é˜æ›´æ–°ä¸€æ¬¡ä»‹é¢ä¸Šçš„æ™‚é–“é¡¯ç¤º
        setInterval(() => {
            if(document.getElementById('home-page').classList.contains('active')) {
                renderEvents();
            }
        }, 60000);

        // åˆå§‹è¼‰å…¥æ™‚è¨­å®šå…¨å±€é¡è‰²
        document.addEventListener('DOMContentLoaded', () => {
            const initialColor = localStorage.getItem(GLOBAL_COLOR_KEY) || '#4F46E5';
            updateGlobalColor(initialColor);
            renderEvents();
            switchPage('home'); // ç¢ºä¿åœ¨ home é é¢ï¼Œæ—¥æ›†æŒ‰éˆ•æœƒé¡¯ç¤º
        });
    </script>
</body>
</html>
